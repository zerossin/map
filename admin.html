<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>관리자 페이지</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f5f5f5;
        }
        
        /* 로그인 화면 */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        
        .login-box {
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 400px;
        }
        
        .login-box h1 {
            margin-bottom: 30px;
            text-align: center;
            color: #333;
        }
        
        .login-box input {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .login-box button {
            width: 100%;
            padding: 12px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }
        
        .login-box button:hover {
            background: #45a049;
        }
        
        .error-message {
            color: #F44336;
            font-size: 14px;
            margin-bottom: 15px;
            text-align: center;
            display: none;
        }
        
        /* 관리자 페이지 */
        .admin-container {
            display: none;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .logout-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 8px 16px;
            background: #F44336;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            z-index: 1000;
        }
        
        .logout-btn:hover {
            background: #D32F2F;
        }
        
        h1 {
            margin-bottom: 30px;
            color: #333;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #eee;
        }
        
        .tab {
            padding: 10px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            color: #666;
            border-bottom: 3px solid transparent;
        }
        
        .tab.active {
            color: #4CAF50;
            border-bottom-color: #4CAF50;
        }
        
        .filter-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .filter-btn {
            padding: 8px 16px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .filter-btn.active {
            background: #4CAF50;
            color: white;
            border-color: #4CAF50;
        }
        
        .suggestion-list, .review-list {
            display: none;
        }
        
        .suggestion-list.active, .review-list.active {
            display: block;
        }
        
        .suggestion-item, .review-item {
            background: #f9f9f9;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 8px;
            border-left: 4px solid #ccc;
        }
        
        .suggestion-item.pending {
            border-left-color: #FFC107;
        }
        
        .suggestion-item.approved {
            border-left-color: #4CAF50;
        }
        
        .suggestion-item.rejected {
            border-left-color: #F44336;
        }
        
        .suggestion-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .type-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .type-add {
            background: #E3F2FD;
            color: #1976D2;
        }
        
        .type-edit {
            background: #FFF3E0;
            color: #F57C00;
        }
        
        .type-feedback {
            background: #F3E5F5;
            color: #7B1FA2;
        }
        
        .status-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .status-pending {
            background: #FFF3CD;
            color: #856404;
        }
        
        .status-approved {
            background: #D4EDDA;
            color: #155724;
        }
        
        .status-rejected {
            background: #F8D7DA;
            color: #721C24;
        }
        
        .suggestion-content {
            margin: 15px 0;
        }
        
        .suggestion-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .suggestion-text {
            color: #555;
            line-height: 1.6;
            white-space: pre-wrap;
        }
        
        .suggestion-meta {
            display: flex;
            gap: 20px;
            font-size: 14px;
            color: #999;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        
        .suggestion-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .action-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
        }
        
        .btn-approve {
            background: #4CAF50;
            color: white;
        }
        
        .btn-reject {
            background: #F44336;
            color: white;
        }
        
        .btn-delete {
            background: #9E9E9E;
            color: white;
        }
        
        .action-btn:hover {
            opacity: 0.8;
        }
        
        .empty-message {
            text-align: center;
            color: #999;
            padding: 40px;
        }
    </style>
</head>
<body>
    <!-- 로그인 화면 -->
    <div class="login-container" id="loginContainer">
        <div class="login-box">
            <h1>🔐 관리자 로그인</h1>
            <div class="error-message" id="errorMessage">비밀번호가 일치하지 않습니다.</div>
            <input type="password" id="passwordInput" placeholder="비밀번호를 입력하세요" autocomplete="off">
            <button onclick="login()">로그인</button>
        </div>
    </div>
    
    <!-- 관리자 페이지 -->
    <div class="admin-container" id="adminContainer">
        <button class="logout-btn" onclick="logout()">로그아웃</button>
        <div class="container">
            <h1>🛠️ 관리자 페이지</h1>
        
        <div class="tabs">
            <button class="tab active" onclick="showTab('suggestions')">제안 관리</button>
            <button class="tab" onclick="showTab('reviews')">리뷰 관리</button>
        </div>
        
        <!-- 제안 관리 -->
        <div class="suggestion-list active" id="suggestions">
            <div class="filter-buttons">
                <button class="filter-btn active" onclick="filterSuggestions('all')">전체</button>
                <button class="filter-btn" onclick="filterSuggestions('pending')">대기중</button>
                <button class="filter-btn" onclick="filterSuggestions('approved')">승인됨</button>
                <button class="filter-btn" onclick="filterSuggestions('rejected')">거부됨</button>
            </div>
            
            <div id="suggestionContainer">
                <!-- JavaScript로 동적 생성 -->
            </div>
        </div>
        
        <!-- 리뷰 관리 -->
        <div class="review-list" id="reviews">
            <div id="reviewContainer">
                <!-- JavaScript로 동적 생성 -->
            </div>
        </div>
    </div>
    </div>
    
    <script>
        let currentFilter = 'all';
        
        // ===== 인증 관련 =====
        async function checkAuth() {
            // 먼저 로그인 화면 표시 (기본)
            showLoginPage();
            
            try {
                // 서버에 세션 확인 요청
                const response = await fetch('https://api.zerossin.com/suggestions', {
                    credentials: 'include'  // 쿠키 전송
                });
                
                if (response.ok) {
                    // 인증 성공 - 관리자 페이지 표시
                    showAdminPage();
                } else if (response.status === 403) {
                    // 인증 실패 - 로그인 화면 유지
                    showLoginPage();
                }
                // 다른 에러는 로그인 화면 유지 (이미 표시됨)
            } catch (error) {
                console.error('Auth check error:', error);
                // CORS 에러 등 - 로그인 화면 유지 (이미 표시됨)
            }
        }
        
        async function login() {
            const password = document.getElementById('passwordInput').value;
            const errorMsg = document.getElementById('errorMessage');
            
            if (!password) {
                errorMsg.textContent = '비밀번호를 입력하세요.';
                errorMsg.style.display = 'block';
                setTimeout(() => errorMsg.style.display = 'none', 3000);
                return;
            }
            
            try {
                const response = await fetch('https://api.zerossin.com/admin/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',  // 쿠키 전송
                    body: JSON.stringify({ password })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    showAdminPage();
                } else {
                    errorMsg.textContent = data.error || '비밀번호가 일치하지 않습니다.';
                    errorMsg.style.display = 'block';
                    document.getElementById('passwordInput').value = '';
                    
                    setTimeout(() => {
                        errorMsg.style.display = 'none';
                    }, 3000);
                }
            } catch (error) {
                console.error('Login error:', error);
                errorMsg.textContent = '로그인 중 오류가 발생했습니다.';
                errorMsg.style.display = 'block';
                setTimeout(() => errorMsg.style.display = 'none', 3000);
            }
        }
        
        async function logout() {
            if (!confirm('로그아웃 하시겠습니까?')) {
                return;
            }
            
            try {
                await fetch('https://api.zerossin.com/admin/logout', {
                    method: 'POST',
                    credentials: 'include'
                });
            } catch (error) {
                console.error('Logout error:', error);
            }
            
            // 로그인 화면으로 이동
            location.reload();
        }
        
        function showLoginPage() {
            document.getElementById('loginContainer').style.display = 'flex';
            document.getElementById('adminContainer').style.display = 'none';
        }
        
        function showAdminPage() {
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('adminContainer').style.display = 'block';
            loadSuggestions();
        }
        
        // Enter 키 이벤트
        document.addEventListener('DOMContentLoaded', function() {
            const passwordInput = document.getElementById('passwordInput');
            if (passwordInput) {
                passwordInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        login();
                    }
                });
            }
        });
        
        // ===== 탭 관리 =====
        function showTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.suggestion-list, .review-list').forEach(l => l.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tab).classList.add('active');
            
            if (tab === 'suggestions') {
                loadSuggestions();
            } else {
                loadReviews();
            }
        }
        
        // 제안 필터
        function filterSuggestions(status) {
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            currentFilter = status;
            loadSuggestions();
        }
        
        // 제안 목록 로드
        async function loadSuggestions() {
            const url = currentFilter === 'all' 
                ? 'https://api.zerossin.com/suggestions'
                : `https://api.zerossin.com/suggestions?status=${currentFilter}`;
            
            try {
                const response = await fetch(url, {
                    credentials: 'include'  // 쿠키 전송
                });
                
                if (response.status === 403) {
                    // 인증 실패 - 로그인 화면으로
                    alert('세션이 만료되었습니다. 다시 로그인해주세요.');
                    location.reload();
                    return;
                }
                
                const suggestions = await response.json();
                
                const container = document.getElementById('suggestionContainer');
                container.innerHTML = '';
                
                if (suggestions.length === 0) {
                    container.innerHTML = '<div class="empty-message">제안이 없습니다.</div>';
                    return;
                }
                
                suggestions.forEach(suggestion => {
                    const typeLabels = {
                        'add': '정보 추가',
                        'edit': '정보 수정',
                        'feedback': '건의사항'
                    };
                    
                    const statusLabels = {
                        'pending': '대기중',
                        'approved': '승인됨',
                        'rejected': '거부됨'
                    };
                    
                    const item = document.createElement('div');
                    item.className = `suggestion-item ${suggestion.status}`;
                    item.innerHTML = `
                        <div class="suggestion-header">
                            <div>
                                <span class="type-badge type-${suggestion.type}">${typeLabels[suggestion.type]}</span>
                                <span class="status-badge status-${suggestion.status}">${statusLabels[suggestion.status]}</span>
                            </div>
                        </div>
                        <div class="suggestion-content">
                            <div class="suggestion-title">${escapeHtml(suggestion.title)}</div>
                            <div class="suggestion-text">${escapeHtml(suggestion.content)}</div>
                        </div>
                        <div class="suggestion-meta">
                            <span>👤 ${escapeHtml(suggestion.username)}</span>
                            <span>📅 ${new Date(suggestion.created_at).toLocaleString('ko-KR')}</span>
                            ${suggestion.coords ? `<span>📍 (${suggestion.coords[0].toFixed(0)}, ${suggestion.coords[1].toFixed(0)})</span>` : ''}
                            ${suggestion.ip ? `<span>🌐 ${suggestion.ip}</span>` : ''}
                        </div>
                        <div class="suggestion-actions">
                            ${suggestion.status === 'pending' ? `
                                <button class="action-btn btn-approve" onclick="updateSuggestionStatus(${suggestion.id}, 'approved')">✓ 승인</button>
                                <button class="action-btn btn-reject" onclick="updateSuggestionStatus(${suggestion.id}, 'rejected')">✗ 거부</button>
                            ` : ''}
                            <button class="action-btn btn-delete" onclick="deleteSuggestion(${suggestion.id})">🗑️ 삭제</button>
                        </div>
                    `;
                    container.appendChild(item);
                });
            } catch (error) {
                console.error('Error loading suggestions:', error);
                document.getElementById('suggestionContainer').innerHTML = '<div class="empty-message">제안 목록을 불러오는 중 오류가 발생했습니다.</div>';
            }
        }
        
        // 제안 상태 업데이트
        async function updateSuggestionStatus(id, status) {
            const message = status === 'approved' ? '승인' : '거부';
            if (!confirm(`이 제안을 ${message}하시겠습니까?`)) {
                return;
            }
            
            try {
                const response = await fetch(`https://api.zerossin.com/suggestions/${id}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',  // 쿠키 전송
                    body: JSON.stringify({ status })
                });
                
                if (response.ok) {
                    alert(`${message}되었습니다.`);
                    loadSuggestions();
                } else {
                    alert('업데이트 중 오류가 발생했습니다.');
                }
            } catch (error) {
                console.error('Error updating suggestion:', error);
                alert('업데이트 중 오류가 발생했습니다.');
            }
        }
        
        // 제안 삭제
        async function deleteSuggestion(id) {
            if (!confirm('이 제안을 삭제하시겠습니까?')) {
                return;
            }
            
            try {
                const response = await fetch(`https://api.zerossin.com/suggestions/${id}`, {
                    method: 'DELETE',
                    credentials: 'include'  // 쿠키 전송
                });
                
                if (response.ok) {
                    alert('삭제되었습니다.');
                    loadSuggestions();
                }
            } catch (error) {
                console.error('Error deleting suggestion:', error);
                alert('삭제 중 오류가 발생했습니다.');
            }
        }
        
        // 리뷰 목록 로드
        async function loadReviews() {
            try {
                const response = await fetch('https://api.zerossin.com/reviews', {
                    credentials: 'include'
                });
                
                if (response.status === 403) {
                    alert('세션이 만료되었습니다. 다시 로그인해주세요.');
                    location.reload();
                    return;
                }
                
                const reviews = await response.json();
                
                const container = document.getElementById('reviewContainer');
                container.innerHTML = '';
                
                if (!Array.isArray(reviews) || reviews.length === 0) {
                    container.innerHTML = '<div class="empty-message">리뷰가 없습니다.</div>';
                    return;
                }
                
                // 최신순 정렬
                reviews.sort((a, b) => new Date(b.created_at || b.createdAt) - new Date(a.created_at || a.createdAt));
                
                reviews.forEach(review => {
                    const item = document.createElement('div');
                    item.className = 'suggestion-item';
                    
                    // 올바른 필드명 사용
                    const placeName = review.placeName || review.place_name || '알 수 없는 위치';
                    const content = review.comment || '(내용 없음)';
                    const rating = review.rating || 0;
                    const stars = '⭐'.repeat(rating);
                    const username = review.username || '익명';
                    const createdAt = new Date(review.created_at || review.createdAt).toLocaleString('ko-KR');
                    const ip = review.ip || 'N/A';
                    const coords = review.coords;
                    
                    item.innerHTML = `
                        <div class="suggestion-header">
                            <div>
                                <span class="type-badge type-add">${stars} ${escapeHtml(placeName)}</span>
                            </div>
                        </div>
                        <div class="suggestion-content">
                            <div class="suggestion-text">${escapeHtml(content)}</div>
                        </div>
                        <div class="suggestion-meta">
                            <span>👤 ${escapeHtml(username)}</span>
                            <span>📅 ${createdAt}</span>
                            ${coords ? `<span>📍 (${coords[0].toFixed(4)}, ${coords[1].toFixed(4)})</span>` : ''}
                            <span>🌐 ${ip}</span>
                        </div>
                        <div class="suggestion-actions">
                            <button class="action-btn btn-delete" onclick="deleteReview(${review.id})">🗑️ 삭제</button>
                        </div>
                    `;
                    container.appendChild(item);
                });
            } catch (error) {
                console.error('Error loading reviews:', error);
                document.getElementById('reviewContainer').innerHTML = '<div class="empty-message">리뷰 목록을 불러오는 중 오류가 발생했습니다.</div>';
            }
        }
        
        // 리뷰 삭제
        async function deleteReview(id) {
            if (!confirm('이 리뷰를 삭제하시겠습니까?')) {
                return;
            }
            
            try {
                const response = await fetch(`https://api.zerossin.com/reviews/${id}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                
                if (response.ok) {
                    alert('삭제되었습니다.');
                    loadReviews();
                } else {
                    alert('삭제 중 오류가 발생했습니다.');
                }
            } catch (error) {
                console.error('Error deleting review:', error);
                alert('삭제 중 오류가 발생했습니다.');
            }
        }
        
        // ===== 유틸리티 =====
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // ===== 초기화 =====
        checkAuth();
    </script>
</body>
</html>