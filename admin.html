<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê´€ë¦¬ì í˜ì´ì§€</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f5f5f5;
        }
        
        /* ë¡œê·¸ì¸ í™”ë©´ */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        
        .login-box {
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 400px;
        }
        
        .login-box h1 {
            margin-bottom: 30px;
            text-align: center;
            color: #333;
        }
        
        .login-box input {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .login-box button {
            width: 100%;
            padding: 12px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }
        
        .login-box button:hover {
            background: #45a049;
        }
        
        .error-message {
            color: #F44336;
            font-size: 14px;
            margin-bottom: 15px;
            text-align: center;
            display: none;
        }
        
        /* ê´€ë¦¬ì í˜ì´ì§€ */
        .admin-container {
            display: none;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .logout-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 8px 16px;
            background: #F44336;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            z-index: 1000;
        }
        
        .logout-btn:hover {
            background: #D32F2F;
        }
        
        h1 {
            margin-bottom: 30px;
            color: #333;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #eee;
        }
        
        .tab {
            padding: 10px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            color: #666;
            border-bottom: 3px solid transparent;
        }
        
        .tab.active {
            color: #4CAF50;
            border-bottom-color: #4CAF50;
        }
        
        .filter-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .filter-btn {
            padding: 8px 16px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .filter-btn.active {
            background: #4CAF50;
            color: white;
            border-color: #4CAF50;
        }
        
        .suggestion-list, .review-list {
            display: none;
        }
        
        .suggestion-list.active, .review-list.active {
            display: block;
        }
        
        .suggestion-item, .review-item {
            background: #f9f9f9;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 8px;
            border-left: 4px solid #ccc;
        }
        
        .suggestion-item.pending {
            border-left-color: #FFC107;
        }
        
        .suggestion-item.approved {
            border-left-color: #4CAF50;
        }
        
        .suggestion-item.rejected {
            border-left-color: #F44336;
        }
        
        .suggestion-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .type-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .type-add {
            background: #E3F2FD;
            color: #1976D2;
        }
        
        .type-edit {
            background: #FFF3E0;
            color: #F57C00;
        }
        
        .type-feedback {
            background: #F3E5F5;
            color: #7B1FA2;
        }
        
        .status-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .status-pending {
            background: #FFF3CD;
            color: #856404;
        }
        
        .status-approved {
            background: #D4EDDA;
            color: #155724;
        }
        
        .status-rejected {
            background: #F8D7DA;
            color: #721C24;
        }
        
        .suggestion-content {
            margin: 15px 0;
        }
        
        .suggestion-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .suggestion-text {
            color: #555;
            line-height: 1.6;
            white-space: pre-wrap;
        }
        
        .suggestion-meta {
            display: flex;
            gap: 20px;
            font-size: 14px;
            color: #999;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        
        .suggestion-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .action-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
        }
        
        .btn-approve {
            background: #4CAF50;
            color: white;
        }
        
        .btn-reject {
            background: #F44336;
            color: white;
        }
        
        .btn-delete {
            background: #9E9E9E;
            color: white;
        }
        
        .action-btn:hover {
            opacity: 0.8;
        }
        
        .empty-message {
            text-align: center;
            color: #999;
            padding: 40px;
        }
    </style>
</head>
<body>
    <!-- ë¡œê·¸ì¸ í™”ë©´ -->
    <div class="login-container" id="loginContainer">
        <div class="login-box">
            <h1>ğŸ” ê´€ë¦¬ì ë¡œê·¸ì¸</h1>
            <div class="error-message" id="errorMessage">ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</div>
            <input type="password" id="passwordInput" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”" autocomplete="off">
            <button onclick="login()">ë¡œê·¸ì¸</button>
        </div>
    </div>
    
    <!-- ê´€ë¦¬ì í˜ì´ì§€ -->
    <div class="admin-container" id="adminContainer">
        <button class="logout-btn" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
        <div class="container">
            <h1>ğŸ› ï¸ ê´€ë¦¬ì í˜ì´ì§€</h1>
        
        <div class="tabs">
            <button class="tab active" onclick="showTab('suggestions')">ì œì•ˆ ê´€ë¦¬</button>
            <button class="tab" onclick="showTab('reviews')">ë¦¬ë·° ê´€ë¦¬</button>
        </div>
        
        <!-- ì œì•ˆ ê´€ë¦¬ -->
        <div class="suggestion-list active" id="suggestions">
            <div class="filter-buttons">
                <button class="filter-btn active" onclick="filterSuggestions('all')">ì „ì²´</button>
                <button class="filter-btn" onclick="filterSuggestions('pending')">ëŒ€ê¸°ì¤‘</button>
                <button class="filter-btn" onclick="filterSuggestions('approved')">ìŠ¹ì¸ë¨</button>
                <button class="filter-btn" onclick="filterSuggestions('rejected')">ê±°ë¶€ë¨</button>
            </div>
            
            <div id="suggestionContainer">
                <!-- JavaScriptë¡œ ë™ì  ìƒì„± -->
            </div>
        </div>
        
        <!-- ë¦¬ë·° ê´€ë¦¬ -->
        <div class="review-list" id="reviews">
            <div id="reviewContainer">
                <!-- JavaScriptë¡œ ë™ì  ìƒì„± -->
            </div>
        </div>
    </div>
    </div>
    
    <script>
        let currentFilter = 'all';
        
        // ===== ì¸ì¦ ê´€ë ¨ =====
        async function checkAuth() {
            // ë¨¼ì € ë¡œê·¸ì¸ í™”ë©´ í‘œì‹œ (ê¸°ë³¸)
            showLoginPage();
            
            try {
                // ì„œë²„ì— ì„¸ì…˜ í™•ì¸ ìš”ì²­
                const response = await fetch('https://api.zerossin.com/suggestions', {
                    credentials: 'include'  // ì¿ í‚¤ ì „ì†¡
                });
                
                if (response.ok) {
                    // ì¸ì¦ ì„±ê³µ - ê´€ë¦¬ì í˜ì´ì§€ í‘œì‹œ
                    showAdminPage();
                } else if (response.status === 403) {
                    // ì¸ì¦ ì‹¤íŒ¨ - ë¡œê·¸ì¸ í™”ë©´ ìœ ì§€
                    showLoginPage();
                }
                // ë‹¤ë¥¸ ì—ëŸ¬ëŠ” ë¡œê·¸ì¸ í™”ë©´ ìœ ì§€ (ì´ë¯¸ í‘œì‹œë¨)
            } catch (error) {
                console.error('Auth check error:', error);
                // CORS ì—ëŸ¬ ë“± - ë¡œê·¸ì¸ í™”ë©´ ìœ ì§€ (ì´ë¯¸ í‘œì‹œë¨)
            }
        }
        
        async function login() {
            const password = document.getElementById('passwordInput').value;
            const errorMsg = document.getElementById('errorMessage');
            
            if (!password) {
                errorMsg.textContent = 'ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.';
                errorMsg.style.display = 'block';
                setTimeout(() => errorMsg.style.display = 'none', 3000);
                return;
            }
            
            try {
                const response = await fetch('https://api.zerossin.com/admin/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',  // ì¿ í‚¤ ì „ì†¡
                    body: JSON.stringify({ password })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    showAdminPage();
                } else {
                    errorMsg.textContent = data.error || 'ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
                    errorMsg.style.display = 'block';
                    document.getElementById('passwordInput').value = '';
                    
                    setTimeout(() => {
                        errorMsg.style.display = 'none';
                    }, 3000);
                }
            } catch (error) {
                console.error('Login error:', error);
                errorMsg.textContent = 'ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                errorMsg.style.display = 'block';
                setTimeout(() => errorMsg.style.display = 'none', 3000);
            }
        }
        
        async function logout() {
            if (!confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }
            
            try {
                await fetch('https://api.zerossin.com/admin/logout', {
                    method: 'POST',
                    credentials: 'include'
                });
            } catch (error) {
                console.error('Logout error:', error);
            }
            
            // ë¡œê·¸ì¸ í™”ë©´ìœ¼ë¡œ ì´ë™
            location.reload();
        }
        
        function showLoginPage() {
            document.getElementById('loginContainer').style.display = 'flex';
            document.getElementById('adminContainer').style.display = 'none';
        }
        
        function showAdminPage() {
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('adminContainer').style.display = 'block';
            loadSuggestions();
        }
        
        // Enter í‚¤ ì´ë²¤íŠ¸
        document.addEventListener('DOMContentLoaded', function() {
            const passwordInput = document.getElementById('passwordInput');
            if (passwordInput) {
                passwordInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        login();
                    }
                });
            }
        });
        
        // ===== íƒ­ ê´€ë¦¬ =====
        function showTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.suggestion-list, .review-list').forEach(l => l.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tab).classList.add('active');
            
            if (tab === 'suggestions') {
                loadSuggestions();
            } else {
                loadReviews();
            }
        }
        
        // ì œì•ˆ í•„í„°
        function filterSuggestions(status) {
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            currentFilter = status;
            loadSuggestions();
        }
        
        // ì œì•ˆ ëª©ë¡ ë¡œë“œ
        async function loadSuggestions() {
            const url = currentFilter === 'all' 
                ? 'https://api.zerossin.com/suggestions'
                : `https://api.zerossin.com/suggestions?status=${currentFilter}`;
            
            try {
                const response = await fetch(url, {
                    credentials: 'include'  // ì¿ í‚¤ ì „ì†¡
                });
                
                if (response.status === 403) {
                    // ì¸ì¦ ì‹¤íŒ¨ - ë¡œê·¸ì¸ í™”ë©´ìœ¼ë¡œ
                    alert('ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
                    location.reload();
                    return;
                }
                
                const suggestions = await response.json();
                
                const container = document.getElementById('suggestionContainer');
                container.innerHTML = '';
                
                if (suggestions.length === 0) {
                    container.innerHTML = '<div class="empty-message">ì œì•ˆì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                    return;
                }
                
                suggestions.forEach(suggestion => {
                    const typeLabels = {
                        'add': 'ì •ë³´ ì¶”ê°€',
                        'edit': 'ì •ë³´ ìˆ˜ì •',
                        'feedback': 'ê±´ì˜ì‚¬í•­'
                    };
                    
                    const statusLabels = {
                        'pending': 'ëŒ€ê¸°ì¤‘',
                        'approved': 'ìŠ¹ì¸ë¨',
                        'rejected': 'ê±°ë¶€ë¨'
                    };
                    
                    const item = document.createElement('div');
                    item.className = `suggestion-item ${suggestion.status}`;
                    item.innerHTML = `
                        <div class="suggestion-header">
                            <div>
                                <span class="type-badge type-${suggestion.type}">${typeLabels[suggestion.type]}</span>
                                <span class="status-badge status-${suggestion.status}">${statusLabels[suggestion.status]}</span>
                            </div>
                        </div>
                        <div class="suggestion-content">
                            <div class="suggestion-title">${escapeHtml(suggestion.title)}</div>
                            <div class="suggestion-text">${escapeHtml(suggestion.content)}</div>
                        </div>
                        <div class="suggestion-meta">
                            <span>ğŸ‘¤ ${escapeHtml(suggestion.username)}</span>
                            <span>ğŸ“… ${new Date(suggestion.created_at).toLocaleString('ko-KR')}</span>
                            ${suggestion.coords ? `<span>ğŸ“ (${suggestion.coords[0].toFixed(0)}, ${suggestion.coords[1].toFixed(0)})</span>` : ''}
                            ${suggestion.ip ? `<span>ğŸŒ ${suggestion.ip}</span>` : ''}
                        </div>
                        <div class="suggestion-actions">
                            ${suggestion.status === 'pending' ? `
                                <button class="action-btn btn-approve" onclick="updateSuggestionStatus(${suggestion.id}, 'approved')">âœ“ ìŠ¹ì¸</button>
                                <button class="action-btn btn-reject" onclick="updateSuggestionStatus(${suggestion.id}, 'rejected')">âœ— ê±°ë¶€</button>
                            ` : ''}
                            <button class="action-btn btn-delete" onclick="deleteSuggestion(${suggestion.id})">ğŸ—‘ï¸ ì‚­ì œ</button>
                        </div>
                    `;
                    container.appendChild(item);
                });
            } catch (error) {
                console.error('Error loading suggestions:', error);
                document.getElementById('suggestionContainer').innerHTML = '<div class="empty-message">ì œì•ˆ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
            }
        }
        
        // ì œì•ˆ ìƒíƒœ ì—…ë°ì´íŠ¸
        async function updateSuggestionStatus(id, status) {
            const message = status === 'approved' ? 'ìŠ¹ì¸' : 'ê±°ë¶€';
            if (!confirm(`ì´ ì œì•ˆì„ ${message}í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                return;
            }
            
            try {
                const response = await fetch(`https://api.zerossin.com/suggestions/${id}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',  // ì¿ í‚¤ ì „ì†¡
                    body: JSON.stringify({ status })
                });
                
                if (response.ok) {
                    alert(`${message}ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                    loadSuggestions();
                } else {
                    alert('ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('Error updating suggestion:', error);
                alert('ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }
        
        // ì œì•ˆ ì‚­ì œ
        async function deleteSuggestion(id) {
            if (!confirm('ì´ ì œì•ˆì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }
            
            try {
                const response = await fetch(`https://api.zerossin.com/suggestions/${id}`, {
                    method: 'DELETE',
                    credentials: 'include'  // ì¿ í‚¤ ì „ì†¡
                });
                
                if (response.ok) {
                    alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    loadSuggestions();
                }
            } catch (error) {
                console.error('Error deleting suggestion:', error);
                alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }
        
        // ë¦¬ë·° ëª©ë¡ ë¡œë“œ
        async function loadReviews() {
            try {
                const response = await fetch('https://api.zerossin.com/reviews', {
                    credentials: 'include'
                });
                
                if (response.status === 403) {
                    alert('ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
                    location.reload();
                    return;
                }
                
                const reviews = await response.json();
                
                const container = document.getElementById('reviewContainer');
                container.innerHTML = '';
                
                if (!Array.isArray(reviews) || reviews.length === 0) {
                    container.innerHTML = '<div class="empty-message">ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                    return;
                }
                
                // ìµœì‹ ìˆœ ì •ë ¬
                reviews.sort((a, b) => new Date(b.created_at || b.createdAt) - new Date(a.created_at || a.createdAt));
                
                reviews.forEach(review => {
                    const item = document.createElement('div');
                    item.className = 'suggestion-item';
                    
                    // ì˜¬ë°”ë¥¸ í•„ë“œëª… ì‚¬ìš©
                    const placeName = review.placeName || review.place_name || 'ì•Œ ìˆ˜ ì—†ëŠ” ìœ„ì¹˜';
                    const content = review.comment || '(ë‚´ìš© ì—†ìŒ)';
                    const rating = review.rating || 0;
                    const stars = 'â­'.repeat(rating);
                    const username = review.username || 'ìµëª…';
                    const createdAt = new Date(review.created_at || review.createdAt).toLocaleString('ko-KR');
                    const ip = review.ip || 'N/A';
                    const coords = review.coords;
                    
                    item.innerHTML = `
                        <div class="suggestion-header">
                            <div>
                                <span class="type-badge type-add">${stars} ${escapeHtml(placeName)}</span>
                            </div>
                        </div>
                        <div class="suggestion-content">
                            <div class="suggestion-text">${escapeHtml(content)}</div>
                        </div>
                        <div class="suggestion-meta">
                            <span>ğŸ‘¤ ${escapeHtml(username)}</span>
                            <span>ğŸ“… ${createdAt}</span>
                            ${coords ? `<span>ğŸ“ (${coords[0].toFixed(4)}, ${coords[1].toFixed(4)})</span>` : ''}
                            <span>ğŸŒ ${ip}</span>
                        </div>
                        <div class="suggestion-actions">
                            <button class="action-btn btn-delete" onclick="deleteReview(${review.id})">ğŸ—‘ï¸ ì‚­ì œ</button>
                        </div>
                    `;
                    container.appendChild(item);
                });
            } catch (error) {
                console.error('Error loading reviews:', error);
                document.getElementById('reviewContainer').innerHTML = '<div class="empty-message">ë¦¬ë·° ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
            }
        }
        
        // ë¦¬ë·° ì‚­ì œ
        async function deleteReview(id) {
            if (!confirm('ì´ ë¦¬ë·°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }
            
            try {
                const response = await fetch(`https://api.zerossin.com/reviews/${id}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                
                if (response.ok) {
                    alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    loadReviews();
                } else {
                    alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('Error deleting review:', error);
                alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }
        
        // ===== ìœ í‹¸ë¦¬í‹° =====
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // ===== ì´ˆê¸°í™” =====
        checkAuth();
    </script>
</body>
</html>